{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <title>Home</title>
</head>
<body>
    {% include 'header.html' %}
    <main>
        <div class="intro">
            <div class="intro__container container">
                <div class="intro__suptitle">- The theme of August</div>
                <div class="intro__title">The 100 best <br> recipes of the XXI century</div>
                <button class="intro__btn">
                    Watch
                </button>
            </div>
        </div>
        <div class="articles">
            <div class="articles__container container">
                <div class="articles__name">
                    More than 1210 recipes
                </div>
                <div class="articles__items">
                    {% for article in articles %}
                    <a href="{% url 'article' article.id %}" class="articles__item">
                        <img src="{{ article.image.url }}" alt="" class="articles__img">
                        <div class="articles__title">
                            {{article.name}}
                        </div>
                        <div class="articles__date">
                            {{article.date}}
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
        <!-- CHAT -->
        <div id="chatWindow" class="chat-window">
            <div class="chat-header">
                <h5>Support</h5>
                <button id="closeChat" class="close-btn">&times;</button>
            </div>
            <div id="chatBody" class="chat-body">
                {% for message in messages %}
                    <p class="chatMessage"><strong>{{ message.sender.username }}:</strong> {{ message.text }} <small>{{ message.timestamp }}</small></p>
                {% endfor %}
            </div>
            <form method="post" id="message-form">
                {% csrf_token %}
                {{ form.text }} 
                <button type="submit" class="send-btn">Send</button>
            </form>
        </div>
        <button id="openChat" class="open-btn">Support</button>
    </main>
    {% include 'footer.html' %}

     <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="{% static 'script/app.js' %}"></script>
    <script>
        $(document).ready(function() {
            // Обновление чата каждые 5 секунд
            setInterval(loadChat, 5000);
        
            // Функция загрузки сообщений чата с сервера
            function loadChat() {
                $.ajax({
                    url: '{% url "chat_view" %}', // URL для получения сообщений
                    method: 'GET',
                    success: function(response) {
                        $('#chatBody').html(response.html); // Обновление содержимого окна чата
                    }
                });
            }
        
            // Обработка отправки формы через AJAX
            $('#message-form').submit(function(event) {
                event.preventDefault(); // Предотвращение стандартной отправки формы
                $.ajax({
                    url: '{% url "chat_view" %}', // URL для отправки сообщений
                    method: 'POST',
                    data: $(this).serialize(),
                    success: function(response) {
                        $('#chatBody').html(response.html); // Обновление сообщений в чате
                        $('#message-form')[0].reset(); // Сброс формы
                    }
                });
            });
        
            // Закрытие чат-окна
            $('#closeChat').click(function() {
                $('#chatWindow').hide(); // Скрытие контейнера чата
            });
        
            // Открытие чат-окна
            $('#openChat').click(function() {
                $('#chatWindow').show(); // Показать контейнер чата
            });
        });
        </script>
</body>
</html>